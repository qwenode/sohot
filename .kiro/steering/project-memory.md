---
inclusion: always
---

# SoHot 项目记忆

## 项目概述
SoHot 是一个 Go 语言开发的文件监控和热重载工具，类似于 nodemon 或其他语言的热重载工具。主要用于开发过程中自动监控文件变更、编译和重启程序。

## 核心架构

### 主要模块
- **main.go** - 程序入口，提供交互式配置选择界面
- **e/env.go** - 配置管理模块，使用 viper 读取 TOML 配置
- **watch/watch.go** - 核心功能模块，包含文件监控、编译、运行逻辑
- **gen.go** - 构建脚本，用于生成发布版本

### 技术依赖
- `github.com/fsnotify/fsnotify` - 文件系统监控
- `github.com/spf13/viper` - 配置文件管理
- `github.com/rs/zerolog` - 结构化日志记录
- `github.com/manifoldco/promptui` - 交互式命令行界面
- `rr v0.0.0` - 本地字符串处理库（../rr 路径）

## 配置系统

### 配置文件结构 (sohot.toml)
```toml
[log]
level = -1  # 日志级别

[watch]
include = ["."]           # 监控目录
exclude = ["tmp/"]        # 排除目录（系统自动排除 .git, .idea, .exe）

[build]
delay = 1000             # 编译延迟（毫秒）
name = "./tmp/test.exe"  # 输出可执行文件路径
package = "main.go"      # 主包路径
command = []             # 额外编译参数

[run.a]
command = ["aa"]         # 运行参数

[run.b]
only = true             # 仅运行模式
command = ["bb"]        # 运行参数
```

### 运行模式
1. **普通模式** - 监控源码文件，变更时自动编译并重启
2. **仅运行模式** (only=true) - 只监控可执行文件，适用于只需要重启的场景

## 核心功能实现

### 文件监控 (Watching)
- 使用 fsnotify 监控指定目录
- 支持包含/排除规则过滤
- 递归监控子目录
- 自动排除 .git, .idea, .exe 等系统文件

### 智能编译 (Building)
- **延迟编译机制** - 防止频繁文件变更导致重复编译
- **倒计时显示** - 编译延迟期间显示剩余时间
- **进程管理** - 自动终止旧的编译进程
- **文件锁处理** - Windows 下强制删除被占用的可执行文件

### 程序运行 (Running)
- 自动启动编译后的程序
- 管道输出重定向到控制台
- 优雅的进程终止和重启
- 信号处理和资源清理

## Windows 平台特殊处理

### 强制文件删除策略
1. 重命名为临时文件
2. 使用 taskkill 终止占用进程
3. PowerShell 强制删除
4. 自动清理临时文件

### 临时文件管理
- 启动时清理 `*.delete_me_*` 临时文件
- 程序退出时自动清理
- 信号处理确保资源释放

## 开发模式和使用场景

### 典型工作流程
1. 启动 sohot，选择配置模式
2. 程序开始监控指定目录
3. 检测到文件变更后延迟编译
4. 编译成功后自动重启程序
5. 循环监控直到手动停止

### 适用场景
- Go 语言 Web 服务开发
- CLI 工具开发调试
- 任何需要频繁重启的 Go 程序开发

## 项目状态
- ✅ 核心功能完整实现
- ✅ Windows 平台兼容性良好
- ✅ 配置系统灵活可扩展
- ✅ 错误处理和日志记录完善
- ✅ 进程管理和资源清理机制健全

## 注意事项
- 依赖本地 rr 库，需要确保 ../rr 路径存在
- Windows 平台下的文件删除需要特殊处理
- 编译延迟时间可根据项目大小调整
- 监控目录过大时可能影响性能